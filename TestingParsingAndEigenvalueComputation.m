

%% Explicit large example

% xp is dx/dt

eqs={'xp1 == 0.3440*x10 + 0.4474';
     'xp2 == 0.0038*x2 + 0.6549*x10 + 0.7845*x13 + 0.0040*x14 + 0.2282*x19 + 0.9734';
     'xp3 == 0.6267*u5 + 0.0651*x12 + 0.3473*x16 + 0.8588';
      'xp4 == 0.0598*u5 + 0.2887*x17 + 0.0327*x18 + 0.8685';
      'xp5 == 0.0831*u4 + 0.38984*x15 + 0.1381*x18 + 0.2472';
      'xp6 == 0.4737*x8 + 0.0856*x16 + 0.2286*x18 + 1.6085';
      'xp7 == 0.0838*u5 + 0.2301*x11 + 0.2002*x12 + 0.8884';
      'xp8 == 0.0998*u5 + 0.66*x9 + 0.0515*x10 + 0.5883';
      'xp9 == 0.6785*u2 + 0.0110*x7 + 0.4883*x9 + 0.2754*x12 + 0.6573';
     'xp10 == 0.0276*x1 + 0.2263*x19 + 0.3483';
     'xp11 == 0.0549*u2 + 0.2598*x3 + 0.2733*x12 + 0.0994*x16 + 0.1905*x20 + 1.9020';
     'xp12 == 0.0732*u5 + 0.0466*u6 + 0.8391';
     'xp13 == 0.1264*u1 + 0.5706*x5 + 0.0839*x13 + 0.2854*x20 + 1.4471';
    'xp14 == 0.4188*x8 + 0.4638';
    'xp15 == 0.7539*u1 + 0.4065*x15 + 0.5479';
    'xp16 == 0.0105*u2 + 0.1236*x1 + 0.1916*x4 + 0.0859*x6 + 0.1613*x18 + 1.0436';
    'xp17 == 0.2431*u3 + 0.0820';
    'xp18 == 0.0578*x2 + 0.0867*x4 + 0.0267*x5 + 0.0526*x8 + 2.5279';
    'xp19 == 0.2644*u5 + 0.4517*x12 + 1.1073';
    'xp20 == 0.5101*u4 + 0.3917'};

xpOP=zeros(20,1);
xOP=[
   -0.1668;
   -0.4590;
    0.5462;
   -1.3023;
   -0.4115;
   -0.5401;
    1.3665;
    0.7068;
    0.6076;
    0.9198;
    0.8994;
    0.0327;
   -1.4159;
   -1.6809;
    0.0378;
    1.6635;
    0.8310;
    1.0477;
    1.7938;
   -0.4851;];

uOP =[
   -0.6336;
    1.1019;
   -0.7170;
    2.2000;
    0.8906;
   -0.6354;];

% converting symbolic equations to dmss object / CPN1 tensor
sys=sym2dmss(eqs,0);

% linearization to get 
descriptorModel=linearize(sys,xpOP,xOP,uOP,[],[])

%  descriptorModel.E
% 
% ans =
% 
%   20×20 sparse double matrix (20 nonzeros)
% 
%    (1,1)        1
%    (2,2)        1
%    (3,3)        1
%    (4,4)        1
%    (5,5)        1
%    (6,6)        1
%    (7,7)        1
%    (8,8)        1
%    (9,9)        1
%   (10,10)       1
%   (11,11)       1
%   (12,12)       1
%   (13,13)       1
%   (14,14)       1
%   (15,15)       1
%   (16,16)       1
%   (17,17)       1
%   (18,18)       1
%   (19,19)       1
%   (20,20)       1


% descriptorModel.A
% 
% ans =
% 
%   20×20 sparse double matrix (42 nonzeros)
% 
%   (10,1)       0.0276
%   (16,1)       0.1236
%    (2,2)       0.0038
%   (18,2)       0.0578
%   (11,3)       0.2598
%   (16,4)       0.1916
%   (18,4)       0.0867
%   (13,5)       0.5706
%   (18,5)       0.0267
%   (16,6)       0.0859
%    (9,7)       0.0110
%    (6,8)       0.4737
%   (14,8)       0.4188
%   (18,8)       0.0526
%    (8,9)       0.6600
%    (9,9)       0.4883
%    (1,10)      0.3440
%    (2,10)      0.6549
%    (8,10)      0.0515
%    (7,11)      0.2301
%    (3,12)      0.0651
%    (7,12)      0.2002
%    (9,12)      0.2754
%   (11,12)      0.2733
%   (19,12)      0.4517
%    (2,13)      0.7845
%   (13,13)      0.0839
%    (2,14)      0.0040
%    (5,15)      0.3898
%   (15,15)      0.4065
%    (3,16)      0.3473
%    (6,16)      0.0856
%   (11,16)      0.0994
%    (4,17)      0.2887
%    (4,18)      0.0327
%    (5,18)      0.1381
%    (6,18)      0.2286
%   (16,18)      0.1613
%    (2,19)      0.2282
%   (10,19)      0.2263
%   (11,20)      0.1905
%   (13,20)      0.2854


% ATTENTION: this is the sparse generalized eigenproblem, where only a
% subset of generalized eigenvalues are computed using the sparse matrices
eigs(descriptorModel.A,descriptorModel.E)

sparseGeneralizedEigenvalues=[
   0.4892 + 0.0000i;
   0.4065 + 0.0000i;
   0.2729 + 0.0000i;
   0.0222 + 0.2359i;
   0.0222 - 0.2359i;
  -0.2326 + 0.0000i;




%% Test with implicit multilinear model 

eqs={'xp1==(x3+ 0.2732*1/3*((-2*u1+u2+u3)*x2+sqrt(3)*(u2-u3)*(x1))+2*pi*50)*(-y2)';
     'xp2==(x3+ 0.2732*1/3*((-2*u1+u2+u3)*x2+sqrt(3)*(u2-u3)*(x1))+2*pi*50)*y1'; 
     'xp3==(0.022508948*1/3*((-2*u1+u2+u3)*x2+sqrt(3)*(u2-u3)*(x1)))';   
     '0==y1-x1';
     '0==y2-x2'};

% Constructing CPN1 tensor and multilinear model

run DemoPLL.mlx % To be replaced by your routine

% Operating point
xpOP =[0;0;0];
xOP  =[-0.5737;   -0.8193;   -0.1597];
uOP  =[-100.6109;-217.5716;318.1824];
yOP  =[-0.5737;-0.8193];
  
% Linearization
descriptorModel=linearize(sys,xpOP,xOP,uOP,yOP,[]);

% Generalized eigenvalues
eig(descriptorModel)

% these matrices are usually sparse but I made them full to help in the comparison
E=                [ 3     0     0     0     0;
                    0     3     0     0     0;
                    0     0     3     0     0;
                    0     0     0     0     0;
                    0     0     0     0     0;]; 

A=   1.0e+03 * [-0.207706314347718 ,  0.067560023915976, 0.002457900000000 ,                  0 , -1.019881260396390;
             0.145442588235428 ,-0.047307684267784 , -0.001721100000000,   1.019881260396390,                  0;
            -0.020887249162832 , 0.006793934298105 ,                  0,                   0 ,                  0;
            -0.001000000000000 ,                  0,                  0,   0.001000000000000,                   0;
             0                 , -0.001000000000000,                  0,                   0,   0.001000000000000;];


% Eigen 
eig(A,E)

generalizedEigenvalues= 1.0e+02 *
  [-0.4250 + 3.5014i;
  -0.4250 - 3.5014i;
  -0.0001 + 0.0000i;
      Inf + 0.0000i;
     -Inf + 0.0000i;];

