<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      -->
<title>mlgreyest</title>
<meta name="generator" content="MATLAB 24.1">
<link rel="schema.DC" href="http://purl.org/dc/elements/1.1/">
<meta name="DC.date" content="2024-06-24">
<meta name="DC.source" content="mlgreyestDoc.m">
<style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; }

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }
span.typesection { color:#A0522D }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style>
</head>
<body>
<div class="content">
<h1>mlgreyest</h1>
<!--introduction-->
<p>grey box parameter estimation for MTI models with an ALS algorithm</p>
<!--/introduction-->
<h2>Contents</h2>
<div>
<ul>
<li>
<a href="#1">Syntax</a>
</li>
<li>
<a href="#2">Description</a>
</li>
<li>
<a href="#4">Input arguments</a>
</li>
<li>
<a href="#5">Output arguments</a>
</li>
<li>
<a href="#6">ALS for low-rank 1-norm MTI models</a>
</li>
<li>
<a href="#7">Example parameter estimation norm-1 MTI</a>
</li>
<li>
<a href="#10">Example nonnegative parameter estimation norm-1 MTI</a>
</li>
<li>
<a href="#12">Example parameter estimation MTI with otvlTens structure</a>
</li>
<li>
<a href="#17">Options</a>
</li>
<li>
<a href="#18">References</a>
</li>
<li>
<a href="#19">See Also</a>
</li>
</ul>
</div>
<h2 id="1">Syntax</h2>
<p>
<tt>[sys,J] = mlgreyest(data,r)</tt>
</p>
<p>
<tt>[sys,J] = mlgreyest(data,1,structuralRestrictions)</tt>
</p>
<p>
<tt>[sys,J] = mlgreyest(data,r, options)</tt>
</p>
<h2 id="2">Description</h2>
<p>Use <tt>mlgreyest</tt> to perform rank n parameter identification with normalized MTI models in <a href="CPN1Doc.html"><tt>CPN1</tt></a> format or MTI models given as an <a href="otvlTensDoc.html"><tt>otvlTens</tt></a>-object from iddata object with input-output data in time-domain. Function returns model with estimated parameters and the final estimation cost.</p>
<p>Identification is performed with an Alternating Least Squares algorithm (ALS). The ALS is already widely used for the factorisation of matrices (Krzanowski 1988) and has been adapted to the decomposition of CP tensors (Kolda und Bader 2009) and to the tensor train decomposition in (Batselier 2020). It can also be applied for parameter estimation of multilinear models.</p>
<p><hr width="100%" size="1" color="LightGray"></p>
<p>
<tt>[sys,J] = mlgreyest(data,r)</tt> identifies a multilinear Model of rank r in 1-norm CPN representation with default options</p>
<p><hr width="100%" size="1" color="LightGray"></p>
<p>
<tt>[sys,J] = mlgreyest(data,1,structuralRestrictions)</tt> identifies a multilinear model whose equation structure is given as an otvlTens object</p>
<p><hr width="100%" size="1" color="LightGray"></p>
<p>
<tt>[sys,J] = mlgreyest(data,r, options)</tt> identifies a multilinear model with custom options</p>
<h2 id="4">Input arguments</h2>
<p>
<tt>data</tt> measurement iddata object <tt>r</tt> rank <tt>structuralRestrictions</tt> <a href="otvlTensDoc.html"><tt>otvlTens</tt></a> object [optional]</p>
<h2 id="5">Output arguments</h2>
<p>
<tt>sys</tt> mss object <tt>J</tt> cost function result</p>
<h2 id="6">ALS for low-rank 1-norm MTI models</h2>
<p>Consider the discrete-time multilinear state equation</p>
<p>
<img src="mlgreyestDoc_eq15957038624986081120.png" alt="$ \mathbf{x}(k+1) = \sum_{r=1}^{R} \left(  \left(\mathbf{F}_i(1,r) + \mathbf{F}_i(2,r) z_i(k)\right) \prod_{j=J(1)}^{J(n+m-1)} \left((1 - \left|\mathbf{F}_j(2,r)\right| + \mathbf{F}_j(2,r) z_j(k)\right) \Phi(:,r) \right) $" style="width:589px;height:27px;">,</p>
<p>with <img src="mlgreyestDoc_eq12614388370685719119.png" alt="$z_i(k), z_j(k)\in\mathbf{z} = [x_1(k),x_2(k),...x_n(k),u_1(k),u_2(k),...,u_m(k)]$" style="width:261px;height:11px;">. The factor matrices <img src="mlgreyestDoc_eq03189164201797028175.png" alt="$\mathbf{F}_i$" style="width:9px;height:9px;"> with <img src="mlgreyestDoc_eq15871432903325095350.png" alt="$i=1,\dots,n+m$" style="width:69px;height:9px;"> and <img src="mlgreyestDoc_eq09830357746721224170.png" alt="$\mathbf{F}_j$" style="width:10px;height:10px;"> with <img src="mlgreyestDoc_eq03300942048216082285.png" alt="$j\in J=\{1,2,\dots,n+m\} \backslash \{i\}$" style="width:126px;height:10px;"> have the dimensions <img src="mlgreyestDoc_eq10755870456427961184.png" alt="${\bf{R}}^{2\times R}$" style="width:22px;height:9px;"> and are normalized to the <img src="mlgreyestDoc_eq02136768035765927026.png" alt="$1$" style="width:4px;height:7px;">-norm, see also [1].</p>
<p>If <img src="mlgreyestDoc_eq03189164201797028175.png" alt="$\mathbf{F}_i$" style="width:9px;height:9px;"> is the matrix with free parameters and all other matrices <img src="mlgreyestDoc_eq09830357746721224170.png" alt="$\mathbf{F}_j$" style="width:10px;height:10px;"> are fixed to a number, the equation of state can be expressed as a linear equation and solved by standard linear regression methods.</p>
<p>With an alternating change of the free parameter dimension <img src="mlgreyestDoc_eq08984912804010224726.png" alt="$i$" style="width:3px;height:7px;"> through all <img src="mlgreyestDoc_eq12836738581438173849.png" alt="$n+m$" style="width:27px;height:7px;"> dimensions, the cost function value</p>
<p>
<img src="mlgreyestDoc_eq07383446858411663228.png" alt="$$ J = \|\mathbf{x}-\mathbf{x}_{sim}\|_F $$" style="width:70px;height:10px;"></p>
<p>decreases until the specified cancellation criterion is met.</p>
<h2 id="7">Example parameter estimation norm-1 MTI</h2>
<p>A system is given in <a href="CPN1Doc.html"><tt>CPN1</tt></a> format with:</p>
<p>
<img src="mlgreyestDoc_eq04895266552190210229.png" alt="$$&#10;\mathbf{F}_\mathrm{U} = \left(\begin{array}{cc}&#10;0.83 &amp; 0 \\&#10;0 &amp; 0.53 \\&#10;1 &amp; 0&#10;\end{array}\right),&#10;$$" style="width:101px;height:35px;"></p>
<p>
<img src="mlgreyestDoc_eq16174265703294110754.png" alt="$$&#10;\mathbf{F}_\mathrm{phi} = \left(\begin{array}{cc}&#10;1.0080 &amp; 0 \\&#10;0 &amp; 1.040&#10;\end{array}\right),&#10;$$" style="width:117px;height:24px;"></p>
<pre class="codeinput">
<span class="comment">% Create a discrete-time MTI model</span>
F.U = [[0.83, 0]; [0, 0.53]; [1, 0]];
F.phi= [[1.0080, 0]; [0, 1.040]];
Ts=1;
sys=mss(CPN1(F.U,F.phi),Ts);

<span class="comment">% Create state data from MTI</span>
u=[zeros(20,1);ones(20,1);-ones(20,1)]; <span class="comment">%input</span>
x0=[0;0]; <span class="comment">%initial condition</span>
xsim=msim(sys,u,length(u), x0);
</pre>
<p>The state data can be identified as an MTI model with a freely chosen rank r. Default identification algorithm is ALS.</p>
<pre class="codeinput">
<span class="comment">% Use ALS for identification</span>
data=iddata(xsim(1:end-1,:),u); <span class="comment">%create iddata object from state data</span>
r=4;
sysId=mlgreyest(data,r);
Fu = sysId.F.U
Fphi = sysId.F.phi
xsimId=msim(sysId,u,length(u), x0);
</pre>
<pre class="codeoutput">Identification finished: number of iterations: 200, final cost: 12.0478

Fu =

    0.1897    0.7166    0.5774    0.3213
    0.4108    0.4869    0.4417    0.2082
    0.3041   -0.9412   -0.9871    0.7178


Fphi =

    2.2832    5.7649  -10.6209   -6.7332
    4.1736    6.0868   -9.7241   -7.3089

</pre>
<pre class="codeinput">
<span class="comment">% Compare given and identified data</span>
tiledlayout(3,1);
nexttile
plot(u);
title(<span class="string">'Input data'</span>)
legend(<span class="string">'input'</span>)
nexttile
plot(xsim);
title(<span class="string">'Original data'</span>)
legend(<span class="string">'data_{x1}'</span>,<span class="string">'data_{x2}'</span>)
nexttile
plot(xsimId);
title(<span class="string">'Identified data'</span>)
legend(<span class="string">'sim_{x1}'</span>,<span class="string">'sim_{x2}'</span>)
</pre>
<img vspace="5" hspace="5" src="mlgreyestDoc_01.png" alt=""> <h2 id="10">Example nonnegative parameter estimation norm-1 MTI</h2>
<p>The estimated parameters <img src="mlgreyestDoc_eq17938513841281396675.png" alt="$\mathbf{F}_\mathrm{U}$" style="width:12px;height:9px;"> might be required to be nonnegative. This can be achieved by using the <tt>Nonnegative</tt> option of <tt>mlgreyest</tt>.</p>
<pre class="codeinput">
<span class="comment">% Use nonnegative ALS for identification</span>
sysIdNonneg=mlgreyest(data,r,<span class="string">"Nonnegative"</span>,true);
Fu = sysIdNonneg.F.U
Fphi = sysIdNonneg.F.phi
xsimNonneg=msim(sysIdNonneg,u,length(u), x0);
</pre>
<pre class="codeoutput">Identification finished: number of iterations: 3, final cost: 0.015247

Fu =

    0.1135    0.1597    0.5202    0.9791
    0.6513    1.0000    0.6845         0
    0.4834    0.7861    0.2958    0.8411


Fphi =

    0.3053    0.1220   -0.4892    1.0711
    3.3821   -2.0494   -0.4165    0.1848

</pre>
<pre class="codeinput">
<span class="comment">% Compare given and identified data</span>
tiledlayout(3,1);
nexttile
plot(u);
title(<span class="string">'Input data'</span>)
legend(<span class="string">'input'</span>)
nexttile
plot(xsim);
title(<span class="string">'Original data'</span>)
legend(<span class="string">'data_{x1}'</span>,<span class="string">'data_{x2}'</span>)
nexttile
plot(xsimNonneg);
title(<span class="string">'Identified data nonnegative ALS'</span>)
legend(<span class="string">'sim_{x1}'</span>,<span class="string">'sim_{x2}'</span>)
</pre>
<img vspace="5" hspace="5" src="mlgreyestDoc_02.png" alt=""> <h2 id="12">Example parameter estimation MTI with otvlTens structure</h2>
<p>Parameter estimation can also be performed for <a href="mssDoc.html"><tt>mss</tt></a> with a multilinear structure given by an <a href="otvlTensDoc.html"><tt>otvlTens</tt></a>-object.</p>
<p>A multilinear systems state equations are given by</p>
<p>
<img src="mlgreyestDoc_eq01178479854557584779.png" alt="$$&#10;\left(\begin{array}{c}&#10;x_1(k+1) \\&#10;x_2(k+1) \\&#10;x_3(k+1)&#10;\end{array}\right) = \left(\begin{array}{c}&#10;c_1\\&#10;\phi_1 \left(a_{21} -x_1 \left(k\right)\right)\left(a_{22} -x_2&#10;\left(k\right)\right)\left(x_3 \left(k\right)+a_{13} \right)+\phi_2&#10;\left(x_1 \left(k\right)+a_{11} \right)\left(a_{22} -x_2 \left(k\right)\right)+\phi_3 \left(a_{21} -x_1 \left(k\right)\right)\left(x_2 \left(k\right)+a_{12} \right)\left(a_{23} -x_3 \left(k\right)\right)+c_2\\&#10;\phi_4 \left(a_{21} -x_1 \left(k\right)\right)\left(a_{23} -x_3 \left(k\right)\right)+\phi_5 \left(x_1 \left(k\right)+a_{11} \right)\left(x_3 \left(k\right)+a_{23} \right)+c_3&#10;\end{array}\right)&#10;$$" style="width:605px;height:34px;"></p>
<p>Those equations can be represented in an <a href="otvlTensDoc.html"><tt>otvlTens</tt></a>-object:</p>
<pre class="codeinput">
<span class="comment">%create OTVL structures for state equations</span>
myTvlStruct1 = false(0,0,2);
myTvlStruct1(:,:,1) = zeros(0,3); <span class="comment">%position of dont cares</span>
myTvlStruct1(:,:,2) = zeros(0,3); <span class="comment">%Boolean values</span>
myTvlStruct2 = false(3,3,2);
myTvlStruct2(:,:,1) = [0 0 0; 0 0 1; 0 0 0]; <span class="comment">%position of dont cares</span>
myTvlStruct2(:,:,2) = [0 0 1; 1 0 0; 0 1 0]; <span class="comment">%Boolean values</span>
myTvlStruct3 = false(2,3,2);
myTvlStruct3(:,:,1) = [0 1 0; 0 1 0]; <span class="comment">%position of dont cares</span>
myTvlStruct3(:,:,2) = [0 0 0; 1 0 1]; <span class="comment">%Boolean values</span>

<span class="comment">%create  OTVLs</span>
myOTvl1 = otvl(myTvlStruct1);
myOTvl2 = otvl(myTvlStruct2);
myOTvl3 = otvl(myTvlStruct3);
</pre>
<p>An <a href="otvlTensDoc.html"><tt>otvlTens</tt></a>-object with unknown parameters can be created by initializing the parameter matrices 'FPhi', 'Fa' and 'Fc' as 0-by-0 arrays.</p>
<pre class="codeinput">
<span class="comment">% create otvlTens</span>
oTens = otvlTens([], [], [], myOTvl1, myOTvl2, myOTvl3);
</pre>
<p>Perform parameter esimation for MTI with otvlTens structure:</p>
<pre class="codeinput">load(<span class="string">"xDataNoisy.mat"</span>)
rank = 1;
[sysID, costID] = mlgreyest(xDataNoisy,rank,oTens,<span class="string">"Focus"</span>,<span class="string">"prediction"</span>, <span class="string">"Display"</span>,<span class="string">"on"</span>);
</pre>
<pre class="codeoutput">Warning: Rank limitation is currently only implemented through the strucutral
restrictions 
Identification finished: number of iterations: 199, number of initializations: 1, final cost: 0.23785
</pre>
<img vspace="5" hspace="5" src="mlgreyestDoc_03.png" alt=""> <pre class="codeinput">
<span class="comment">%simulation of identified model</span>
timestep = 1;
tEnd = 150;
omssID = mss(sysID, timestep);
simID = msim(omssID, [],1:tEnd, xDataNoisy.y(1,:));

<span class="comment">%compare given and identified results</span>
newcolors = [0 0.5 1; 0.5 0 1; 0.7 0.7 0.7];
figure()
colororder(newcolors)
plot(1:length(xDataNoisy.y), xDataNoisy.y,1:tEnd+1,simID, <span class="string">'--'</span>)
xlabel(<span class="string">'discrete steps'</span>)
ylabel(<span class="string">'simulation states'</span>)
legend(<span class="string">'x1 given'</span>, <span class="string">'x2 given'</span>, <span class="string">'x3 given'</span>, <span class="string">'x1 ID'</span>, <span class="string">'x2 ID'</span>, <span class="string">'x3 ID'</span>);
</pre>
<pre class="codeoutput">Warning: Warning: inputCount is fixed to zero, as only autonomous systems are
implented currently 
</pre>
<img vspace="5" hspace="5" src="mlgreyestDoc_04.png" alt=""> <h2 id="17">Options</h2>
<p>Supported options for general <a href="mssDoc.html"><tt>mss</tt></a>-object:</p>
<p><h3>Initialize</h3></p>
<p>Handling of initial parameters (F0) during estimation. Specify as one of the following: 'random': F0 is initialized random. Default. 'estimate': Initial parameters are estimated with global optimization algorithm. Not supported for alternating linear scheme algorithm</p>
<p><h3>Display</h3></p>
<p>View estimation progress ('on'/'off'). Default: 'off'.</p>
<p><h3>Normtype</h3></p>
<p>spezifies the normalization typ of the mti cpn object. Default: "1-norm"</p>
<p><h3>Method</h3></p>
<p>The method for the optimization in set here. 'als': for altenating linear scheme optimization 'fmincon': for general nonlinear optimization using the interior point algorithm 'lsqnonlin': for nonlinear least squares optimization. Default: 'als'</p>
<p><h3>Nonnegative</h3></p>
<p>set to 'true' to perform nonnegative parameter estimation with ALS algorithm. Default: 'false'</p>
<p><h3>AlsTolerance</h3></p>
<p>criteria to terminate the alternating linear scheme optimization if the value in AlsTolerance is reached. Default: 1</p>
<p><h3>AlsIterations</h3></p>
<p>criteria to terminate the alternating linear scheme optimization if themaximum number of iterations is reached. Default: 200</p>
<p><h3>MaxFunctionNonlin</h3></p>
<p>maximal number of function evaluation in nonlinear optimization. Default: 1000000</p>
<p><hr width="100%" size="1" color="LightGray"></p>
<p>Supported options for <a href="mssDoc.html"><tt>mss</tt></a>-object with structure given by <a href="otvlTensDoc.html"><tt>otvlTens</tt></a>-object:</p>
<p><h3>Initialize</h3></p>
<p>Handling of initial parameters (FPhi, Fa, Fc) during estimation. Specify as one of the following: 'random': parameters are initialized random. Default. 'none': parameters are initialized by ones and zeros preserving the structure contained in the otvlTens object 'user': parameters are read from the otvlTens object</p>
<p><h3>Display</h3></p>
<p>View estimation progress ('on'/'off'). Default: 'off'.</p>
<p><h3>AlsTolerance</h3></p>
<p>Criteria to terminate the alternating linear scheme optimization if the value in AlsTolerance is reached. Default: 1</p>
<p><h3>AlsIterations</h3></p>
<p>criteria to terminate the alternating linear scheme optimization if themaximum number of iterations is reached. Default: 200</p>
<h2 id="18">References</h2>
<p>[1] N. J&ouml;res et al. "Reduced CP representation of multilinear models" in Proceedings of the 12th International Conference on Simulation and Modeling Methodologies, Technologies and Applications, 2022.</p>
<h2 id="19">See Also</h2>
<p> <a href="mssDoc.html"><tt>mss</tt></a> <a href="CPN1Doc.html"><tt>CPN1</tt></a> <a href="otvlTensDoc.html">otvlTens</a>
</p>
<p class="footer">
<br>
<a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2024a</a>
<br>
</p>
</div>
<!--
##### SOURCE BEGIN #####
%% mlgreyest
% grey box parameter estimation for MTI models with an ALS algorithm
%
%% Syntax
% |[sys,J] = mlgreyest(data,r)| 
%
% |[sys,J] = mlgreyest(data,1,structuralRestrictions)|
%
% |[sys,J] = mlgreyest(data,r, options)|
%
%% Description
% Use |mlgreyest| to perform rank n parameter identification
% with normalized MTI models in <CPN1Doc.html |CPN1|> format
% or MTI models given as an <otvlTensDoc.html |otvlTens|>-object 
% from iddata object with input-output data in time-domain. Function
% returns model with estimated parameters and the final estimation cost.
%
% Identification is performed with an Alternating Least Squares algorithm 
% (ALS). The ALS is already widely used for the factorisation of matrices 
% (Krzanowski 1988) and has been adapted to the decomposition of CP tensors
% (Kolda und Bader 2009) and to the tensor train decomposition in 
% (Batselier 2020). It can also be applied for parameter estimation of 
% multilinear models.
%

%%
%
% <html><hr width="100%" size="1" color="LightGray"></html>
%
% |[sys,J] = mlgreyest(data,r)| identifies a multilinear Model of rank r in 1-norm
% CPN representation with default options
%
% <html><hr width="100%" size="1" color="LightGray"></html>
%
% |[sys,J] = mlgreyest(data,1,structuralRestrictions)| identifies a
% multilinear model whose equation structure is given as an otvlTens object
%
% <html><hr width="100%" size="1" color="LightGray"></html>
%
% |[sys,J] = mlgreyest(data,r, options)| identifies a multilinear model
% with custom options

%% Input arguments                                    
% |data|    measurement iddata object                                                                   
% |r|   	rank                               
% |structuralRestrictions| <otvlTensDoc.html |otvlTens|> object [optional]

%% Output arguments
% |sys|     mss object
% |J|   cost function result

%% ALS for low-rank 1-norm MTI models
% Consider the discrete-time multilinear state equation
%
% $$
% \mathbf{x}(k+1) = \sum_{r=1}^{R} \left(  \left(\mathbf{F}_i(1,r) +
% \mathbf{F}_i(2,r) z_i(k)\right) \prod_{j=J(1)}^{J(n+m-1)} \left((1 -
% \left|\mathbf{F}_j(2,r)\right| + \mathbf{F}_j(2,r) z_j(k)\right) \Phi(:,r)
% \right)
% $$,
%
% with $z_i(k), z_j(k)\in\mathbf{z} = [x_1(k),x_2(k),...x_n(k),u_1(k),u_2(k),...,u_m(k)]$. The 
% factor matrices $\mathbf{F}_i$ with $i=1,\dots,n+m$ and 
% $\mathbf{F}_j$ with $j\in J=\{1,2,\dots,n+m\} \backslash \{i\}$ have the 
% dimensions ${\bf{R}}^{2\times R}$ and are normalized to the $1$-norm, see
% also [1]. 
% 
% If $\mathbf{F}_i$ is the matrix with free parameters and all other
% matrices $\mathbf{F}_j$ are fixed to a number, the equation of state can
% be expressed as a linear equation and solved by standard linear
% regression methods.
%
% With an alternating change of the free parameter dimension $i$ through
% all $n+m$ dimensions, the cost function value
%
%
% $$ J = \|\mathbf{x}-\mathbf{x}_{sim}\|_F $$
%
% decreases until the specified cancellation criterion is met.
%
%% Example parameter estimation norm-1 MTI 
% A system is given in <CPN1Doc.html |CPN1|> format with:
%
% $$
% \mathbf{F}_\mathrm{U} = \left(\begin{array}{cc}
% 0.83 & 0 \\ 
% 0 & 0.53 \\
% 1 & 0 
% \end{array}\right),
% $$
%
% $$
% \mathbf{F}_\mathrm{phi} = \left(\begin{array}{cc}
% 1.0080 & 0 \\ 
% 0 & 1.040 
% \end{array}\right),
% $$

% Create a discrete-time MTI model
F.U = [[0.83, 0]; [0, 0.53]; [1, 0]];
F.phi= [[1.0080, 0]; [0, 1.040]];
Ts=1;
sys=mss(CPN1(F.U,F.phi),Ts);

% Create state data from MTI
u=[zeros(20,1);ones(20,1);-ones(20,1)]; %input
x0=[0;0]; %initial condition
xsim=msim(sys,u,length(u), x0);

%%
% The state data can be identified as an MTI model with a freely chosen
% rank r. Default identification algorithm is ALS.

% Use ALS for identification
data=iddata(xsim(1:end-1,:),u); %create iddata object from state data
r=4;
sysId=mlgreyest(data,r);
Fu = sysId.F.U
Fphi = sysId.F.phi
xsimId=msim(sysId,u,length(u), x0);
%% 

% Compare given and identified data
tiledlayout(3,1);
nexttile
plot(u);
title('Input data')
legend('input')
nexttile
plot(xsim);
title('Original data')
legend('data_{x1}','data_{x2}')
nexttile
plot(xsimId);
title('Identified data')
legend('sim_{x1}','sim_{x2}')

%% Example nonnegative parameter estimation norm-1 MTI
% The estimated parameters $\mathbf{F}_\mathrm{U}$ might be required to be 
% nonnegative. This can be achieved by using the |Nonnegative| option of 
% |mlgreyest|.

% Use nonnegative ALS for identification
sysIdNonneg=mlgreyest(data,r,"Nonnegative",true);
Fu = sysIdNonneg.F.U
Fphi = sysIdNonneg.F.phi
xsimNonneg=msim(sysIdNonneg,u,length(u), x0);

%%

% Compare given and identified data
tiledlayout(3,1);
nexttile
plot(u);
title('Input data')
legend('input')
nexttile
plot(xsim);
title('Original data')
legend('data_{x1}','data_{x2}')
nexttile
plot(xsimNonneg);
title('Identified data nonnegative ALS')
legend('sim_{x1}','sim_{x2}')

%% Example parameter estimation MTI with otvlTens structure
% Parameter estimation can also be performed for <mssDoc.html
% |mss|> with a multilinear structure given by an
% <otvlTensDoc.html |otvlTens|>-object.
%%
% A multilinear systems state equations are given by 
%
% $$
% \left(\begin{array}{c}
% x_1(k+1) \\ 
% x_2(k+1) \\
% x_3(k+1) 
% \end{array}\right) = \left(\begin{array}{c}
% c_1\\
% \phi_1 \left(a_{21} -x_1 \left(k\right)\right)\left(a_{22} -x_2
% \left(k\right)\right)\left(x_3 \left(k\right)+a_{13} \right)+\phi_2
% \left(x_1 \left(k\right)+a_{11} \right)\left(a_{22} -x_2 \left(k\right)\right)+\phi_3 \left(a_{21} -x_1 \left(k\right)\right)\left(x_2 \left(k\right)+a_{12} \right)\left(a_{23} -x_3 \left(k\right)\right)+c_2\\
% \phi_4 \left(a_{21} -x_1 \left(k\right)\right)\left(a_{23} -x_3 \left(k\right)\right)+\phi_5 \left(x_1 \left(k\right)+a_{11} \right)\left(x_3 \left(k\right)+a_{23} \right)+c_3
% \end{array}\right)
% $$
%
% Those equations can be represented in an
% <otvlTensDoc.html |otvlTens|>-object: 

%create OTVL structures for state equations
myTvlStruct1 = false(0,0,2);
myTvlStruct1(:,:,1) = zeros(0,3); %position of dont cares
myTvlStruct1(:,:,2) = zeros(0,3); %Boolean values
myTvlStruct2 = false(3,3,2);
myTvlStruct2(:,:,1) = [0 0 0; 0 0 1; 0 0 0]; %position of dont cares
myTvlStruct2(:,:,2) = [0 0 1; 1 0 0; 0 1 0]; %Boolean values
myTvlStruct3 = false(2,3,2);
myTvlStruct3(:,:,1) = [0 1 0; 0 1 0]; %position of dont cares
myTvlStruct3(:,:,2) = [0 0 0; 1 0 1]; %Boolean values

%create  OTVLs
myOTvl1 = otvl(myTvlStruct1);
myOTvl2 = otvl(myTvlStruct2);
myOTvl3 = otvl(myTvlStruct3);

%%
% An <otvlTensDoc.html |otvlTens|>-object with unknown
% parameters can be created by initializing the parameter matrices 'FPhi',
% 'Fa' and 'Fc' as 0-by-0 arrays.

% create otvlTens
oTens = otvlTens([], [], [], myOTvl1, myOTvl2, myOTvl3);

%%
% Perform parameter esimation for MTI with otvlTens structure:

load("xDataNoisy.mat")
rank = 1;
[sysID, costID] = mlgreyest(xDataNoisy,rank,oTens,"Focus","prediction", "Display","on");

%%

%simulation of identified model
timestep = 1;
tEnd = 150;
omssID = mss(sysID, timestep);
simID = msim(omssID, [],1:tEnd, xDataNoisy.y(1,:));

%compare given and identified results
newcolors = [0 0.5 1; 0.5 0 1; 0.7 0.7 0.7];
figure()
colororder(newcolors)
plot(1:length(xDataNoisy.y), xDataNoisy.y,1:tEnd+1,simID, 'REPLACE_WITH_DASH_DASH')
xlabel('discrete steps')
ylabel('simulation states')
legend('x1 given', 'x2 given', 'x3 given', 'x1 ID', 'x2 ID', 'x3 ID');

%% Options
% Supported options for general <mssDoc.html |mss|>-object:
%
% <html><h3>Initialize</h3></html>  
% 
% Handling of initial parameters (F0) during estimation. Specify as one of 
% the following: 'random': F0 is initialized random. Default.
%             'estimate': Initial parameters are estimated with global
%              optimization algorithm. Not supported for alternating
%              linear scheme algorithm
%
% <html><h3>Display</h3></html>
% 
% View estimation progress ('on'/'off'). Default: 'off'.            
%
% <html><h3>Normtype</h3></html>
% 
% spezifies the normalization typ of the mti cpn object. Default: "1-norm"
%
% <html><h3>Method</h3></html>
% 
% The method for the optimization in set here. 
%                 'als': for altenating linear scheme optimization
%                 'fmincon': for general nonlinear optimization using the interior point algorithm
%                 'lsqnonlin': for nonlinear least squares optimization.
%                 Default: 'als'
%
% <html><h3>Nonnegative</h3></html>
% 
% set to 'true' to perform nonnegative parameter estimation
%                 with ALS algorithm. 
%                 Default: 'false'
%
% <html><h3>AlsTolerance</h3></html>
% 
% criteria to terminate the alternating linear scheme
%                 optimization if the value in AlsTolerance is reached.
%                 Default: 1
%
% <html><h3>AlsIterations</h3></html>
% 
% criteria to terminate the alternating linear scheme
%                 optimization if themaximum number of iterations is reached.
%                 Default: 200
%
% <html><h3>MaxFunctionNonlin</h3></html>
% 
% maximal number of function evaluation in nonlinear
%                  optimization.
%                  Default: 1000000
%
% <html><hr width="100%" size="1" color="LightGray"></html>
%
% Supported options for <mssDoc.html |mss|>-object with 
% structure given by <otvlTensDoc.html |otvlTens|>-object:
%
% <html><h3>Initialize</h3></html>
% 
% Handling of initial parameters (FPhi, Fa, Fc) during estimation.
%               Specify as one of the following:
%               'random': parameters are initialized random. Default.
%               'none': parameters are initialized by ones and zeros
%               preserving the structure contained in the otvlTens object
%               'user': parameters are read from the otvlTens object
%
%
% <html><h3>Display</h3></html>
% 
% View estimation progress ('on'/'off'). Default: 'off'.
%
% <html><h3>AlsTolerance</h3></html>
% 
% Criteria to terminate the alternating linear scheme
%                 optimization if the value in AlsTolerance is reached.
%                 Default: 1
%
% <html><h3>AlsIterations</h3></html>
% 
% criteria to terminate the alternating linear scheme
%                 optimization if themaximum number of iterations is reached.
%                 Default: 200

%% References
% [1] N. JÃ¶res et al. "Reduced CP representation of multilinear models"
% in Proceedings of the 12th International Conference on Simulation and 
% Modeling Methodologies, Technologies and Applications, 2022. 
%

%% See Also
% <mssDoc.html |mss|> <CPN1Doc.html |CPN1|> <otvlTensDoc.html otvlTens>
##### SOURCE END #####
-->
</body>
</html>
